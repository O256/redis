Redis 7.2 发行说明
=======================

--------------------------------------------------------------------------------
升级紧急程度:

低:      除非需要使用新功能,否则无需升级。
中等:    需要计划服务器升级,但不紧急。
高:      存在可能影响部分用户的严重bug。建议升级!
严重:    存在影响大多数用户的严重bug。请尽快升级!
安全:    该版本包含安全修复。
--------------------------------------------------------------------------------


Redis 社区版 7.2.6    发布于 2024年10月2日 20:17:04 IDT
================================================================================

升级紧急程度 安全: 请查看下方安全修复说明。

安全修复
==============

* (CVE-2024-31449) Lua库命令可能导致栈溢出和潜在的远程代码执行。
* (CVE-2024-31227) 由于ACL选择器格式错误可能导致拒绝服务。
* (CVE-2024-31228) 由于无限制的模式匹配可能导致拒绝服务。

Bug修复
=========

* 修复了集群模式下的崩溃问题 (#13315)

================================================================================
Redis 7.2.5    发布于 2024年5月16日 12:00:00 IST
================================================================================

升级紧急程度 中等: 需要计划服务器升级,但不紧急。

Bug修复
=========

* 单分片集群在CLUSTER SLOTS中保留了失败的副本而不是移除它们 (#12824)
* 当替换小项目并超过4GB时LSET命令崩溃 (#12955)
* 由于重新处理命令导致阻塞命令超时被重置 (#13004)
* Lua参数转换为redis参数可能失败。此bug在7.2.0中引入 (#13115)

CLI工具Bug修复
======================

* redis-cli: --count参数(用于--scan, --bigkeys等)在未使用--pattern时被忽略 (#13092)
* redis-check-aof: 错误地将manifest格式的数据视为MP-AOF (#12958)


================================================================================
Redis 7.2.4    发布于 2024年1月9日 10:45:52 IST
================================================================================

升级紧急程度 安全: 请查看下方安全修复说明。

安全修复
==============
* (CVE-2023-41056) 在某些情况下，Redis可能错误处理内存缓冲区的大小调整，
  导致缓冲区大小计算错误，从而引发堆溢出和潜在的远程代码执行。

Bug修复
=========

* 修复7.0和7.2混合版本集群中集群命令的崩溃问题 (#12805, #12832)
* 修复从节点删除槽时槽所有权未被正确处理的问题 (#12564)
* 修复RedisModuleEvent_Key模块API事件的原子性问题 (#12733)


================================================================================
Redis 7.2.3    发布于 2023年11月1日 12:00:00 IST
================================================================================

升级紧急程度: 高，修复影响大多数用户的严重bug。

Bug修复
=========

* 修复副本上阻止已删除文件释放磁盘空间的文件描述符泄漏问题 (#12693)
* 修复集群节点移除后可能发生的崩溃问题 (#12702)


================================================================================
Redis 7.2.2    发布于 2023年10月18日 10:33:40 IDT
================================================================================

升级紧急程度 安全: 请查看下方安全修复说明。

安全修复
==============

* (CVE-2023-45145) listen(2)和chmod(2)调用顺序错误导致竞争条件，
  可被其他进程利用绕过启动时设置的Unix套接字权限。

平台/工具链支持相关变更
=================================================

* 修复MacOS 13上的编译错误 (#12611)

Bug修复
=========

* 在没有写入流量且新建AOF文件而AOF重写无法立即启动时，WAITAOF可能超时 (#12620)

Redis集群
=============

* 修复在7.0和7.2混合集群中运行rebalance命令时的崩溃问题 (#12604)
* 修复cluster shards中槽号的返回类型为整数，与过去行为保持一致 (#12561)
* 修复从模块或脚本调用的CLUSTER命令正确返回TLS信息 (#12569)

CLI工具变更
====================

* redis-cli: 修复SUBSCRIBE模式下重连时的崩溃问题 (#12571)

模块API变更
==================

* 修复下一个定时器事件的溢出计算 (#12474)


================================================================================
Redis 7.2.1    发布于 2023年9月6日 15:00:00 IDT
================================================================================

升级紧急程度 安全: 请查看下方安全修复说明。

安全修复
==============

* (CVE-2023-41053) Redis未能正确识别SORT_RO访问的键，
  因此可能授予执行此命令的用户访问ACL配置未明确授权的键的权限。

Bug修复
=========

* 修复将节点加入现有7.0 Redis集群时的崩溃问题 (#12538)
* 修正某些管理/配置命令的request_policy和response_policy命令提示 (#12545, #12530)


================================================================================
Redis 7.2.0 GA   发布于 2023年8月15日 12:00:00 IDT
================================================================================

升级紧急程度 低: 这是Redis 7.2的第一个稳定版本。

Bug修复
=========

* redis-cli在集群模式下处理`unknown-endpoint` (#12273)
* 更新部分命令的请求/响应策略提示 (#12417)
* 确保在从RDB/AOF加载和副本上禁用函数加载超时 (#12451)
* 修复ACL选择器带有错误括号组合时的虚假成功和内存泄漏 (#12452)
* 修复脚本超时在通知阻塞客户端后的断言问题 (#12459)

修复Redis 7.2之前版本的问题
--------------------------------------------------

* 正确更新MONITOR客户端对INFO和客户端驱逐的内存使用 (#12420)
* cluster nodes响应在没有主机名时不必要地添加额外逗号 (#12411)

================================================================================
Redis 7.2 RC3   发布于 2023年7月10日 12:00:00 IDT
================================================================================

升级紧急程度 低: 这是Redis 7.2的第三个发布候选版本。
如果您使用的是7.2的之前候选版本，升级紧急程度为 安全。

安全修复:
* (CVE-2022-24834) 在Redis中执行的特制Lua脚本可能触发cjson和cmsgpack库中的堆溢出，
  导致堆损坏和潜在的远程代码执行。此问题存在于所有支持Lua脚本的Redis版本中，
  从2.6版本开始，仅影响经过身份验证和授权的用户。
* (CVE-2023-36824) 在某些情况下，从命令和参数列表中提取键名可能触发堆溢出，
  导致随机堆内存读取、堆损坏和潜在的远程代码执行。具体涉及：
  使用COMMAND GETKEYS*和ACL规则中的键名验证。

新功能
============

新的管理和自省命令及命令参数
-------------------------------------------------------------------

* 使SENTINEL CONFIG [SET|GET]支持可变参数 (#10362)

潜在的破坏性/行为变更
=======================================

* 集群分片ID不再在cluster nodes输出中可见，此功能在7.2-RC1中引入 (#10536, #12166)
* 当使用RESP3客户端调用PUBLISH且该客户端也订阅了同一频道时，
  顺序发生变化，回复在发布消息之前发送 (#12326)

新的配置选项
=========================

* 添加新的日志级别"nothing"以禁用日志记录 (#12133)
* 添加cluster-announce-human-nodename - 用于调试日志的节点唯一标识符 (#9564)

其他一般改进
==========================

* 允许在加载期间执行CLUSTER SLOTS / SHARDS命令 (#12269)
* 在未启用"tls-cluster"时支持TLS服务，并在nodes.conf中保留普通和TLS端口 (#12233)
* 更新SPOP和RESTORE命令，当服务器配置为使用异步服务器删除时向副本复制unlink命令 (#12320)
* 尝试延迟释放ZUNION / ZINTER / ZDIFF中的临时有序集合 (#12229)

性能和资源利用改进
=================================================

* 优化PSUBSCRIBE和PUNSUBSCRIBE从O(N*M)到O(N) (#12298)
* 优化SCAN、SSCAN、HSCAN、ZSCAN命令 (#12209)
* 设置Jemalloc --disable-cache-oblivious以减少内存开销 (#12315)
* 优化ZINTERCARD以避免创建临时有序集合 (#12229)
* 优化listpack编码的HRANDFIELD和ZRANDMEMBER (#12205)
* 众多其他优化 (#12155, #12082, #11626, #11944, #12316, #12250, #12177, #12185)

CLI工具变更
====================

* redis-cli: 处理包含NaN的RESP3双精度响应 (#12254)
* redis-cli: 支持IPv6 URI (#11834)

模块API变更
==================

* 统一新的(v7.2 RC2) RM_ReplyWithErrorFormat与RM_ReplyWithError的语义。
  这是一个影响生成错误代码的破坏性变更。 (#12321)
* 禁止在加载和只读副本上使用RM_AddPostNotificationJob (#12304)
* 为模块命令过滤器添加识别正在处理的客户端的能力 (#12219)

Bug修复
=========

* 修复在RESP3发布客户端也订阅该频道时，MULTI中使用PUBLISH的协议错误 (#12326)
* 修复被解除阻塞的模块命令后WAIT的有效性 (#12220)
* 在存在fork子进程时重新启用缩小重哈希 (#12276)
* 修复使用`<count>`时HRANDFIELD、SRANDMEMBER、ZRANDMEMBER可能的挂起问题 (#12276)
* 改善RANDOMKEY、HRANDFIELD、SRANDMEMBER、ZRANDMEMBER、SPOP和驱逐的公平性问题 (#12276)
* 集群：修复槽迁移可能在后续故障转移或节点加入时回滚的竞争条件 (#12344)

修复Redis 7.2之前版本的问题
--------------------------------------------------

* 修复XREADGROUP BLOCK与">"一起使用时的挂起问题 (#12301)
* 修复重新处理时拒绝阻塞命令的断言 (#12247)
* 修复阻塞RM_Call上的使用后释放问题 (#12342)

================================================================================
Redis 7.2 RC2   发布于 2023年5月15日 12:00:00 IST
================================================================================

升级紧急程度 低: 这是Redis 7.2的第二个发布候选版本。

INFO字段和自省变更
=====================================

* 添加一些低级事件循环指标以帮助诊断延迟 (#11963)

性能和资源利用改进
=================================================

* SADD和HSET的小幅性能改进 (#12019)

平台/工具链支持相关变更
=================================================

* 升级到Jemalloc 5.3.0，解决罕见的fork子进程挂起问题 (#12115)
* 修复与链接时优化一起使用时编译器加固导致的崩溃 (#11982)
* 修复本地客户端检测，使用127.*.*.*而不是127.0.0.1 (#11664)
* 在关闭时向systemd报告AOF失败状态 (#12065)

CLI工具变更
====================

* redis-cli: 基于实际命令参数文档重新实现和改进帮助提示 (#10515)
* redis-cli: 添加--count选项用于调整基于SCAN的功能 (#12042)
* redis-benchmark: 添加--seed选项以为随机数生成器设置种子 (#11945)

模块API变更
==================

* 添加RM_RdbLoad和RM_RdbSave API (#11852)
* 添加支持格式字符串的RM_ReplyWithErrorFormat (#11923)
* 修复：当RM_ZsetAdd、RM_ZsetIncrby、RM_StreamAdd失败时删除空键 (#12129)

Bug修复
=========

* LPOS设置RANK为LONG_MIN时返回错误结果 (#12167)
* 避免在罕见情况下主服务器重启后不必要的完全同步 (#12088)
* 处理后台任务时公平地迭代客户端 (#12025)
* 从客户端读取大量数据时避免查询缓冲区的错误收缩 (#12000)
* Sentinel: 修复使用旧known-slave时的配置重写错误 (#11775)
* ACL: 撤销allchannels权限时断开发布/订阅订阅者连接 (#11992)
* 在罕见情况下添加缺失的AOF文件fsync (#11973)

修复Redis 7.2之前版本的问题
--------------------------------------------------

* 修复MULTI、EVAL、WAIT和模块的命令持续时间指标跟踪 (#11970)

================================================================================
Redis 7.2 RC1   发布于 2023年3月22日 12:00:00 IST
================================================================================

升级紧急程度 低: 这是Redis 7.2的第一个发布候选版本。

Redis发布候选(RC)版本是为社区早期采用者提供测试的早期版本。
我们不认为它们适合生产环境。

Redis 7.2版本介绍
=====================================

Redis 7.2包括优化、几个新命令、一些改进、bug修复和几个新��模块API。

特别需要注意以下变更：

1. Redis 7.2使用新的RDB文件格式(版本11)，与旧版本不兼容。
2. 请参见下面提到的破坏性变更部分。
3. 如果您使用模块，请参见下面的模块API破坏性变更部分。

以下是与7.0.10相比此版本的完整变更列表。
每个变更都包含添加它的PR编号，您可以在
https://github.com/redis/redis/pull/<number> 获取更多详细信息

新功能
============

* 引入WAITAOF命令，阻塞客户端直到指定数量的Redis实例将所有先前的写命令
  同步到磁盘上的AOF，详见 https://redis.io/commands/waitaof/

新的用户命令或命令参数
--------------------------------------

* WAITAOF阻塞直到写入已同步到磁盘 (#11713)
* 为ZRANK和ZREVRANK添加WITHSCORE选项 (#11235)

新的管理和自省命令及命令参数
-------------------------------------------------------------------

* CLIENT SETINFO允许客户端库报告名称和版本Redis (#11758)
* CLIENT NO-TOUCH用于客户端运行命令而不影响键的LRU/LFU (#11483)
* 在集群模式下引入分片ID以基于复制逻辑分组节点。
  分片ID自动分配并可通过`CLUSTER MYSHARDID`查看。 (#10536)

扩展的命令回复
---------------------------------------

* ACL LOG - 添加条目ID、创建时间戳和最后更新时间戳 (#11477)
* COMMAND DOCS - 将参数名称重新用作唯一ID (#11051)
* CLIENT LIST有`T`标志表示CLIENT NO-TOUCH (#11483)
* CLIENT LIST显示lib-name、lib-ver (#11758)

潜在的破坏性/行为变更
=======================================

* 脚本的客户端侧跟踪现在跟踪脚本读取的键，而不是EVAL/FCALL调用者声明的键 (#11770)
* 在命令执行和脚本中冻结时间采样 (#10300)
* 当阻塞命令被解除阻塞时，重新评估ACL、OOM等检查 (#11012)
* 统一ACL失败错误消息文本和错误代码 (#11160)
* 当键不再存在时释放的阻塞流命令携带不同的错误代码 (#11012)
* 仅当阻塞命令实际执行时才更新命令统计信息 (#11012)
* ACL用户的内部存储方式不再删除冗余的命令和类别规则，这可能改变这些规则在
  `ACL SAVE`、`ACL GETUSER`和`ACL LIST`中的显示方式 (#11224)
* 为TLS复制创建的客户端连接在可能时使用SNI (#11458)
* 流消费者：重新利用seen-time，添加active-time (#11099)
* XREADGROUP和X[AUTO]CLAIM无论是否能够执行一些读取/声明都创建消费者 (#11099)
* ACL默认新创建用户在ACL LIST/GETUSER中设置sanitize-payload标志 #11279
* 修复HELLO命令在成功之前不影响客户端状态 (#11659)
* 将回复中的`NAN`规范化为单一nan类型，就��我们对`inf`所做的那样 (#11597)

弃用
============

* 将QUIT命令标记为已弃用 (#11439)
* 删除预发布RDB格式的RDB加载代码 (#11058)

性能和资源利用改进
=================================================

* 显著优化小型列表类型键的内存使用 (#11303)
* 显著优化小型集合类型键的内存使用 (#11290)
* 显著优化大型集合的内存使用 (#11595)
* 在整数分数情况下显著优化ZRANGE回复WITHSCORES的速度 (#11779)
* 显著优化双精度回复的速度，主要是有序集合命令 (#10587)
* 优化集群模式下多键命令的性能 (#11044)
* 增量回收RDB文件的操作系统页面缓存 (#11248)
* 当有大量待处理消息时改进集群总线链接的内存管理 (#11343)
* 对不使用流水线的命令工作负载的小幅性能改进 (#11220)

CLI工具变更
====================

* redis-cli在订阅模式下接受命令 (#11873)

其他一般改进
==========================

* WAIT现在不再等待您最后一个命令之后的复制偏移量，
  而是等待您最后一次写入之后的复制偏移量 (#11713)
* 当调用`CLUSTER FORGET`时自动将节点删除传播到集群中的其他节点，
  在大多数情况下允许通过单个调用删除节点 (#10869)
* 在脚本中不允许的阻塞命令现在在脚本中的行为与在MULTI中相同 (#11568)

平台/工具链支持相关变更
=================================================

* 在没有HAVE_MALLOC_SIZE(不是jemalloc或glibc)的情况下编译的32位构建
  将消耗更多内存 (#11595)
* 在ARM上也默认使用jemalloc (#11407)
* 在illumos/solaris的崩溃报告中添加堆栈跟踪和寄存器转储支持 (#11335)

新的配置选项
=========================

* locale-collate运行时配置以控制影响Lua和SORT的setlocale (#11059)
* 在Sentinel中添加CONFIG SET和GET loglevel功能 (#11214)

INFO字段和自省变更
=====================================

* 为身份验证错误和被拒绝访问的键、频道和命令添加4个新的info字段 (#11288)
* INFO SERVER包含监听器列表 (#9320)

模块API变更
==================

* 使模块命令可以成为ACL类别的一部分 (#11708)
* 为RM_Call添加K标志以允许运行阻塞命令并设置回调以获取响应 (#11568)
* 添加RM_AddPostNotificationJob以允许在键空间通知钩子之后进行写入 (#11199)
* RedisModule_Event_Key通知有关键被unlink的信息以及原因和值 (#9406)
* 添加RM_BlockClient[Set|Get]PrivateData以将模块数据与阻塞客户端关联 (#11568)
* API允许模块参与/处理AUTH验证 (#11659)
* RM_GetContextFlags支持新标志：REDISMODULE_CTX_FLAGS_SERVER_STARTUP (#9320)
* 添加REDISMODULE_OPTIONS_ALLOW_NESTED_KEYSPACE_NOTIFICATIONS和RedisModule_GetModuleOptionsAll (#11199)
* RM_BlockClientOnKeysWithFlags允许模块请求在键被删除时解除阻塞 (#11310)
* 引入aux_save2使得可以在RDB中跳过保存该字段并在模块不存在时启用文件加载 (#11374)
* 为RM_Call添加dry run标志以在实际执行前进行验证 (#11158)
* 添加RM_Microseconds和RM_CachedMicroseconds (#11016)
* 添加RM_ACLAddLogEntryByUserName API以在没有用户对象时使用 (#11659)
* 在未使用自动内存的情况下，使得可以将RM_Call回复保留超过上下文生命周期 (#11568)

模块API中的潜在破坏性变更
------------------------------------------

* RM_Call仅在设置'M'标志时对脚本强制执行OOM (#11425)
* 阻止模块命令名称中的某些特定字符 (#11434)
* 修复使用键空间通知的模块的复制不一致性 (#10969)
* 在onload处理程序之后阻止命令、配置、数据类型注册 (#11708)

Bug修复
=========

* 引入套接字关闭以在fork活动时正确断开客户端连接 (#11376)
* CLIENT RESET清除CLIENT NO-EVICT标志 (#11483)
* 减少模块从RDB文件加载的字符串的内存使用 (#11050)
* 修复集群中的节点在另一个节点声明槽时可能不复制或处理已删除键的内部事件的bug (#11084)
* 修复HINCRBYFLOAT在新值无效时不创建键 (#11149)
* 使集群配置文件保存原子化并fsync acl文件保存 (#10924)
* 在RM_Call中使用时WAIT命令不会阻塞 (#11713)
* COMMAND命令中命令元数据的小修复 (#11201, #10273)


感谢所有使这个版本成为可能的用户和开发者。
我们将继续发布更多RC版本，直到代码看起来可以用于生产环境，
并且一段时间内没有收到严重问题的报告。

特别感谢在这个版本中投入大量工作的：

- Meir Shpilraien
- Guy Benoish
- Viktor Söderqvist
- Zhu Binbin
- Oran Agra
- sundb
- Ran Shidlansik
- Zhenwei Pi
- Jason Elbaum
- Karthik Subbarao
- Madelyn Olson
- Huang Zhw
- Ping Xie
- Ozan Tezcan
- Chen Tianjie
- Deng Ju
- Wen Hui
- Brennan Cathcart
- Itamar Haber
- Shaya Potter
- Roshan Khatri
- Slava Koyfman
- Zhu Tian
- Moti Cohen
- Arad Zilberstein
- Basel Naamna
- Mingyi Kang
- Uri Yagelnik
- Filipe Oliveira
- Zhao Zhao
- Valentino Geron
- Yaacov Hazan
- Adi Pinsky
- David Carlier
- Li Changjun 